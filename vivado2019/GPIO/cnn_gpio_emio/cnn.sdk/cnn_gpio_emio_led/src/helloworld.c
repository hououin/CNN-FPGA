#include <xcnn.h>
#include <xparameters.h>
#include <stdio.h>
#include <xtime_l.h>
#include "xgpiops.h"
//#include "time.h"

#define INPUT_ROWS 28
#define INPUT_COLS 28
#define CHANNELS 1
#define DIGITS 10

#define GPIO_DEVICE_ID XPAR_XGPIOPS_0_DEVICE_ID
#define MIO7_LED 7

#define EMIO_LED0 54
#define EMIO_LED1 55
#define EMIO_LED2 56
#define EMIO_LED3 57

//Point to the BRAM Controllers
float *XVecHW = (float *) XPAR_BRAM_0_BASEADDR;
float *resHW = (float *) XPAR_BRAM_1_BASEADDR;

//Crazy function IP core
XCnn doConv1;
XCnn_Config *doConv1_cfg;

XGpioPs gpiops_inst;
XGpioPs_Config * gpiops_cfg_ptr;

void init_conv1Core()
{
	int status = 0;
	//doCrazyFunction_cfg = XCrazyfunction_LookupConfig(XPAR_CRAZYFUNCTION_0_DEVICE_ID);
	doConv1_cfg = XCnn_LookupConfig(XPAR_CNN_0_DEVICE_ID);
	if (doConv1_cfg)
	{
		//status = XCrazyfunction_CfgInitialize(&doCrazyFunction, doCrazyFunction_cfg);
		status = XCnn_CfgInitialize(&doConv1, doConv1_cfg);
		if(status != XST_SUCCESS)
		{
			printf("Failed to initialize\n");
		}
	}
}


int main()
{

	float images[INPUT_ROWS*INPUT_COLS] = {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.32941176470588235,0.7254901960784313,0.6235294117647059,0.592156862745098,0.23529411764705882,0.1411764705882353,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.8705882352941177,0.996078431372549,0.996078431372549,0.996078431372549,0.996078431372549,0.9450980392156862,0.7764705882352941,0.7764705882352941,0.7764705882352941,0.7764705882352941,0.7764705882352941,0.7764705882352941,0.7764705882352941,0.7764705882352941,0.6666666666666666,0.20392156862745098,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.2627450980392157,0.4470588235294118,0.2823529411764706,0.4470588235294118,0.6392156862745098,0.8901960784313725,0.996078431372549,0.8823529411764706,0.996078431372549,0.996078431372549,0.996078431372549,0.9803921568627451,0.8980392156862745,0.996078431372549,0.996078431372549,0.5490196078431373,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.06666666666666667,0.25882352941176473,0.054901960784313725,0.2627450980392157,0.2627450980392157,0.2627450980392157,0.23137254901960785,0.08235294117647059,0.9254901960784314,0.996078431372549,0.41568627450980394,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.3254901960784314,0.9921568627450981,0.8196078431372549,0.07058823529411765,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.08627450980392157,0.9137254901960784,1.0,0.3254901960784314,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.5058823529411764,0.996078431372549,0.9333333333333333,0.17254901960784313,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.23137254901960785,0.9764705882352941,0.996078431372549,0.24313725490196078,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.5215686274509804,0.996078431372549,0.7333333333333333,0.0196078431372549,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.03529411764705882,0.803921568627451,0.9725490196078431,0.22745098039215686,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.49411764705882355,0.996078431372549,0.7137254901960784,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.29411764705882354,0.984313725490196,0.9411764705882353,0.2235294117647059,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.07450980392156863,0.8666666666666667,0.996078431372549,0.6509803921568628,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.011764705882352941,0.796078431372549,0.996078431372549,0.8588235294117647,0.13725490196078433,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.14901960784313725,0.996078431372549,0.996078431372549,0.30196078431372547,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.12156862745098039,0.8784313725490196,0.996078431372549,0.45098039215686275,0.00392156862745098,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.5215686274509804,0.996078431372549,0.996078431372549,0.20392156862745098,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.23921568627450981,0.9490196078431372,0.996078431372549,0.996078431372549,0.20392156862745098,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.4745098039215686,0.996078431372549,0.996078431372549,0.8588235294117647,0.1568627450980392,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.4745098039215686,0.996078431372549,0.8117647058823529,0.07058823529411765,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,
			0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0};


	init_conv1Core();
	printf("initialized\n");

    gpiops_cfg_ptr = XGpioPs_LookupConfig(GPIO_DEVICE_ID);

    XGpioPs_CfgInitialize(&gpiops_inst, gpiops_cfg_ptr, gpiops_cfg_ptr->BaseAddr);

    XGpioPs_SetDirectionPin(&gpiops_inst, MIO7_LED, 1);
    XGpioPs_SetDirectionPin(&gpiops_inst, EMIO_LED0, 1);
    XGpioPs_SetDirectionPin(&gpiops_inst, EMIO_LED1, 1);
    XGpioPs_SetDirectionPin(&gpiops_inst, EMIO_LED2, 1);
    XGpioPs_SetDirectionPin(&gpiops_inst, EMIO_LED3, 1);

    XGpioPs_SetOutputEnablePin(&gpiops_inst, MIO7_LED, 1);
    XGpioPs_SetOutputEnablePin(&gpiops_inst, EMIO_LED0, 1);
    XGpioPs_SetOutputEnablePin(&gpiops_inst, EMIO_LED1, 1);
    XGpioPs_SetOutputEnablePin(&gpiops_inst, EMIO_LED2, 1);
    XGpioPs_SetOutputEnablePin(&gpiops_inst, EMIO_LED3, 1);

	for(int idxX = 0; idxX < INPUT_ROWS*INPUT_COLS; idxX++)
	{
		XVecHW[idxX] = images[idxX];
		printf("%f\n", XVecHW[idxX]);

	}

	//XVecHW[idxX][i][j];


	XTime start,end;

	XCnn_Start(&doConv1);
	XTime_GetTime(&start);
	while(!XCnn_IsDone(&doConv1));
	XTime_GetTime(&end);
	printf("HW finished\n");

	printf("time %f us\n\r", 1.0 * (end-start)/(COUNTS_PER_SECOND/1000000));
	printf("COUNTS_PER_SECOND %lu\n\r", (unsigned long)COUNTS_PER_SECOND);
	printf("time %llu\n\r", (end-start));
	printf("-----------\n");
	float max = 0;
	int number = -1;
	for(int j = 0; j < DIGITS; j++)
	{
		if(resHW[j] > max){
			max = resHW[j];
			number = j;
		}
		printf("%f\n", resHW[j]);
	}

	printf("-----------\n");
	printf("GPIO EMIO %d\n\r", number);

	int binary [4] = {0,0,0,0};
	int ix = 3;

	while(number>0){
		binary[ix] = number % 2;
		ix--;
		number = number / 2;
	}


    while(1){

    	XGpioPs_WritePin(&gpiops_inst, MIO7_LED, 0);
    	XGpioPs_WritePin(&gpiops_inst, EMIO_LED0, binary[0]);
    	XGpioPs_WritePin(&gpiops_inst, EMIO_LED1, binary[1]);
    	XGpioPs_WritePin(&gpiops_inst, EMIO_LED2, binary[2]);
    	XGpioPs_WritePin(&gpiops_inst, EMIO_LED3, binary[3]);

    }

	return 0;
}
